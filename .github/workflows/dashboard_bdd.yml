name: Gerar Dashboard de Qualidade (BDD)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  atualizar-dashboard: # Primeiro Job: Gera e Salva os dados
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name:  Checkout do Reposit贸rio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name:  Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name:  Rodar o Script e Gerar Markdowns
        # AJUSTE 1: Gera os dois arquivos para n茫o dar erro no script de e-mail
        run: |
          python gerar_dashboard.py > README.md
          python gerar_dashboard.py > email_dashboard.md

      - name:  Fazer o Commit Autom谩tico
        run: |
          git config --global user.name "Rob么 da Qualidade (QA Bot)"
          git config --global user.email "qa-bot@solagora.com.br"
          git add README.md email_dashboard.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "docs:  Atualiza dashboard autom谩tico" && git push)

  enviar-email: # Segundo Job: Espera o primeiro terminar e envia
    runs-on: ubuntu-latest
    needs: atualizar-dashboard
    steps:
      - name:  Checkout do Reposit贸rio (Dados Atualizados)
        uses: actions/checkout@v3
        with:
          ref: main       # AJUSTE 2: Garante que pegue o arquivo que o Rob么 acabou de subir
          fetch-depth: 0

      - name:  Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name:  Instalar Depend锚ncias de E-mail
        run: pip install markdown

      - name:  Enviar Relat贸rio por E-mail
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        run: python enviar_email.py